
runtime: local

include:
  - secrets.yaml
  - too.local.extends.yaml

env:
  PROJECT_ID: triax-football
  DATASTORE_EMULATOR_HOST: localhost:8081
  DATASTORE_PROJECT_ID: triax-football
  DATASTORE_DATASET: triax-football
  # DATASTORE_EMULATOR_HOST_PATH: localhost:8081/datastore
  # DATASTORE_EMULATOR_HOST_PATH_V4: localhost:8081/datastore
  DATASTORE_EMULATOR_HOST: localhost:8081

variable:
  DATE:
    use: bash
    value: $(date '+%Y%m%d-%H%M%S')

prep:
  steps:
  - run: |
    DATE=$(date '+%Y%m%d-%H%M%S')
    gcloud datastore export gs://triax-football.appspot.com/datastore-export/${DATE} --namespace=default --project=triax-football

execute:
  jobs:
  - run: gcloud beta emulators datastore start --data-dir=./dev/data/${DATE} --project=triax-football
  - run: echo '$(gcloud beta emulators datastore env-init --data-dir=./dev/data)'

post:
  steps:
  - run: go test -coverprofile=coverage.go.txt ./...
  - run: npm run test -- --coverage
  - run: codecov -f coverage.go.txt -F go
  - run: codecov -f coverage/lcov.info -F nodejs